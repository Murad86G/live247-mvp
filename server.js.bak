const express = require('express');
const path = require('path');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();

const streamsRouter = require('./backend/routes/streams');

const app = express();
const PORT = 3000;

// DB init
const db = new sqlite3.Database('./database/db.sqlite', (err) => {
  if (err) {
    console.error('DB error:', err.message);
    return;
  }
  console.log('âœ… Connected to SQLite database.');

  db.serialize(() => {
    // Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð²
    db.run(`CREATE TABLE IF NOT EXISTS plans (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      price REAL NOT NULL,
      streams_limit INTEGER NOT NULL,
      cpu_limit REAL NOT NULL,
      storage_limit INTEGER NOT NULL,
      description TEXT
    )`);

    // ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹
    db.get("SELECT COUNT(*) as count FROM plans", (err, row) => {
      if (err) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ñ‚Ð°Ñ€Ð¸Ñ„Ð¾Ð²:", err);
        return;
      }
      if (row.count === 0) {
        const stmt = db.prepare("INSERT INTO plans (name, price, streams_limit, cpu_limit, storage_limit, description) VALUES (?, ?, ?, ?, ?, ?)");
        stmt.run("Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹", 9.99, 3, 1.0, 20, "Ð”Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð°: 3 Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¸, 1 CPU, 20 GB");
        stmt.run("Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚", 19.99, 6, 2.0, 50, "ÐžÐ¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾: 6 Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¹, 2 CPU, 50 GB");
        stmt.run("ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼", 39.99, 12, 4.0, 100, "ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼: 12 Ñ‚Ñ€Ð°Ð½ÑÐ»ÑÑ†Ð¸Ð¹, 4 CPU, 100 GB");
        stmt.finalize();
        console.log("âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹");
      }
    });

    // Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÑÑ‚Ñ€Ð¸Ð¼Ð¾Ð²
    db.run(`CREATE TABLE IF NOT EXISTS streams (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      video_url TEXT NOT NULL,
      yt_key TEXT NOT NULL,
      status TEXT DEFAULT 'offline'
    )`);
  });
});

// Middlewares
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// API routes
app.use('/api/streams', streamsRouter(db));

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÐºÐ°
app.use(express.static(path.join(__dirname, 'frontend')));
app.use(express.static(path.join(__dirname, 'public')));

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'frontend', 'index.html'));
});

// Server start
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running at http://localhost:${PORT}`);
});
